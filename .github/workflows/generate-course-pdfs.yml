name: Generate course PDFs

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "apps/koryxa/frontend/content/**"
      - "apps/koryxa/frontend/app/school/**"
      - "apps/koryxa/frontend/scripts/generate-pdf*.mjs"
      - "apps/koryxa/frontend/course-pdf-manifest.json"

permissions:
  contents: write

concurrency:
  group: generate-course-pdfs-${{ github.ref }}
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        working-directory: apps/koryxa/frontend
        run: npm ci

      - name: Install Playwright Chromium (with deps)
        working-directory: apps/koryxa/frontend
        run: npx playwright install --with-deps chromium

      - name: Build frontend
        working-directory: apps/koryxa/frontend
        run: npm run build

      - name: Start frontend (background)
        working-directory: apps/koryxa/frontend
        env:
          PORT: "3010"
          NEXT_PUBLIC_APP_MODE: "V1"
          PDF_RENDER_TOKEN: ${{ secrets.PDF_RENDER_TOKEN }}
        run: |
          nohup npm run start -- -p 3010 > /tmp/koryxa_frontend_3010.log 2>&1 &
          echo $! > /tmp/koryxa_frontend_3010.pid

      - name: Wait for server
        run: |
          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:3010/ >/dev/null 2>&1; then
              echo "Server ready"
              exit 0
            fi
            sleep 1
          done
          echo "Server not ready"
          tail -n 200 /tmp/koryxa_frontend_3010.log || true
          exit 1

      - name: Generate PDFs
        working-directory: apps/koryxa/frontend
        env:
          PDF_BASE_URL: "http://127.0.0.1:3010"
          PDF_RENDER_TOKEN: ${{ secrets.PDF_RENDER_TOKEN }}
          PDF_MANIFEST: "course-pdf-manifest.json"
        run: npm run gen:pdf

      - name: Stop frontend
        if: always()
        run: |
          if [ -f /tmp/koryxa_frontend_3010.pid ]; then
            kill "$(cat /tmp/koryxa_frontend_3010.pid)" || true
          fi

      - name: Commit PDFs (if changed)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps/koryxa/frontend/public/course-pdfs || true
          if git diff --cached --quiet; then
            echo "No PDF changes to commit."
            exit 0
          fi
          git commit -m "chore(pdf): generate course PDFs [skip ci]"
          git push

